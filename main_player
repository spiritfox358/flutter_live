import 'dart:io';
import 'package:flutter/material.dart';
import 'package:dio/dio.dart'; // ç”¨äºä¸‹è½½
import 'package:path_provider/path_provider.dart'; // ç”¨äºè·å–è·¯å¾„

// å¼•å…¥æœ¬åœ°æ’ä»¶
import 'package:my_alpha_player/my_alpha_player.dart';

void main() {
  runApp(const MaterialApp(home: LivePage()));
}

class LivePage extends StatefulWidget {
  const LivePage({Key? key}) : super(key: key);

  @override
  State<LivePage> createState() => _LivePageState();
}

class _LivePageState extends State<LivePage> {
  MyAlphaPlayerController? _playerController;
  String _btnText = "ä¸‹è½½å¹¶æ’­æ”¾";
  bool _isDownloading = false;

  // ä½ çš„ç›®æ ‡è§†é¢‘åœ°å€
  final String _targetUrl = "https://fzxt-resources.oss-cn-beijing.aliyuncs.com/assets/mystery_shop/effect_video/output.mp4";

  // æ’­æ”¾é€»è¾‘ï¼šæ£€æŸ¥æœ¬åœ° -> æ²¡æœ‰å°±ä¸‹è½½ -> æœ‰äº†å°±æ’­æ”¾
  Future<void> _downloadAndPlay() async {
    if (_isDownloading) return;

    try {
      setState(() {
        _isDownloading = true;
        _btnText = "å‡†å¤‡ä¸­...";
      });

      // 1. ç¡®å®šæœ¬åœ°ä¿å­˜è·¯å¾„
      final dir = await getApplicationDocumentsDirectory();
      // å–æ–‡ä»¶åçš„æœ€åä¸€æ®µä½œä¸ºæœ¬åœ°æ–‡ä»¶å (output.mp4)
      final fileName = _targetUrl.split('/').last;
      final savePath = "${dir.path}/$fileName";
      final file = File(savePath);

      // 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      bool exists = await file.exists();
      if (!exists) {
        setState(() => _btnText = "æ­£åœ¨ä¸‹è½½èµ„æº...");
        print("ğŸš€ å¼€å§‹ä¸‹è½½: $_targetUrl");

        // ä½¿ç”¨ Dio ä¸‹è½½
        await Dio().download(_targetUrl, savePath);
        print("âœ… ä¸‹è½½å®Œæˆ: $savePath");
      } else {
        print("ğŸ‘Œ æ–‡ä»¶å·²å­˜åœ¨ï¼Œç›´æ¥æ’­æ”¾");
      }

      // 3. è°ƒç”¨æ’ä»¶æ’­æ”¾
      if (_playerController != null) {
        setState(() => _btnText = "æ’­æ”¾ä¸­");
        // ä¼ å…¥ç»å¯¹è·¯å¾„
        await _playerController!.play(savePath);
      }

    } catch (e) {
      print("âŒ å‡ºé”™: $e");
      setState(() => _btnText = "å‡ºé”™: $e");
    } finally {
      setState(() => _isDownloading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black, // é»‘è‰²èƒŒæ™¯æ–¹ä¾¿çœ‹é€æ˜æ•ˆæœ
      body: Stack(
        children: [
          // èƒŒæ™¯å›¾ (ç”¨äºæµ‹è¯•é€è§†æ•ˆæœ)
          Positioned.fill(
            child: Image.network(
              "https://images.unsplash.com/photo-1534351590666-13e3e96b5017",
              fit: BoxFit.cover,
            ),
          ),

          // 1. AlphaPlayer è§†å›¾ (è¦†ç›–åœ¨æœ€ä¸Šå±‚)
          Positioned.fill(
            child: MyAlphaPlayerView(
              onCreated: (controller) {
                _playerController = controller;
                print("ğŸ“º æ’­æ”¾å™¨å·²åˆ›å»º");
              },
            ),
          ),

          // 2. æ§åˆ¶æŒ‰é’®
          Positioned(
            bottom: 50,
            left: 0,
            right: 0,
            child: Center(
              child: ElevatedButton.icon(
                icon: _isDownloading
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                    : const Icon(Icons.play_arrow),
                label: Text(_btnText),
                onPressed: _downloadAndPlay,
              ),
            ),
          )
        ],
      ),
    );
  }
}